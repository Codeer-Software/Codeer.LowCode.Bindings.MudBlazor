@using Codeer.LowCode.Bindings.MudBlazor.Internal
@using Codeer.LowCode.Blazor.OperatingModel
@inherits MudFieldComponentBase<DateField, MudDateFieldDesign>

@if (IsViewMode) {
  <span class="d-block py-2">@GetViewOnlyValue()</span>
} else {
  <MudDatePicker @bind-Date:get="@GetValue()" @bind-Date:set="@RaiseOnValueChanged" 
                 Disabled="@IsDisabled" ReadOnly="IsViewMode"
                 Variant="MudDesign.Variant" Color="MudDesign.Color" Error="!Field.IsValid" ErrorText="@(Field.ErrorText)"/>
}

@code {
  private bool IsDisabled => Field.IsEnabled == false;
  private bool IsViewMode => Field.IsViewOnly;

  private DateTime? GetValue() => DateTimeHelper.ToDateTime(Field.Value);

  private async Task RaiseOnValueChanged(DateTime? value) {
    await Field.SetValueAsync(DateTimeHelper.ToDateOnly(value));
  }

  private string GetViewOnlyValue() {
    var value = Field.Services.AppInfoService.IsDesignMode ? new DateOnly(2024, 5, 13) : Field.Value;
    try {
      return value?.ToString(Field.Design.Format) ?? string.Empty;
    }
    catch (FormatException) {
      return value?.ToString() ?? string.Empty;
    }
  }

}